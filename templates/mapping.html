<!DOCTYPE html>
<html>
<head>
    <title>Map with Markers</title>
    <!--    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmEmTVXz4FLSsTM3JME9J3VW-WXECqmKw"></script>-->
    <link href="{{ url_for('static',filename='styles/stylesheet1.css') }}" rel="stylesheet" type="text/css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCmEmTVXz4FLSsTM3JME9J3VW-WXECqmKw"></script>
    <script>
        function myFunction(bikenumber) {
            console.log("I am here")
            fetch("http://127.0.0.1:5000/availability/" + bikenumber) // replace with your desired URL
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // assuming the response is in JSON format
                }).then(data => {
                  // Handle the fetched data
                  drawBarChart2(data);
            })

        }
        function standsFunction(stand_number) {
            console.log("I am here")
            fetch("http://127.0.0.1:5000/standsavailability/" + stand_number) // replace with your desired URL
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json(); // assuming the response is in JSON format
                }).then(data => {
                  // Handle the fetched data
                  drawBarChart(data);
            })

        }
    var stand_chart = null;
     var bike_chart = null;

             function drawBarChart(data, id) {
            // Convert the JSON object to an array of [key, value] pairs
            var dataArray = Object.entries(data);

            // Extract the keys (hours) and values (values) arrays from the data array
            var hours = dataArray.map(function (pair) {
                return pair[0];
            });
            var values = dataArray.map(function (pair) {
                return pair[1];
            });


            // Create a new bar chart using Chart.js library
            if (stand_chart !== null) {
                  // If yes, destroy the existing chart
                 stand_chart.destroy();
            }
            var ctx = document.getElementById('barChart').getContext('2d');
            stand_chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Stands',
                        data: values,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)', // Change the bar color as needed
                        borderColor: 'rgba(75, 192, 192, 1)', // Change the bar border color as needed
                        borderWidth: 1 // Change the bar border width as needed
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25 // Set the maximum y-axis value to the highest value in the data plus 1
                        }
                    }
                }
            });
        }
        function drawBarChart2(data) {
            // Convert the JSON object to an array of [key, value] pairs
            var dataArray = Object.entries(data);

            // Extract the keys (hours) and values (values) arrays from the data array
            var hours = dataArray.map(function (pair) {
                return pair[0];
            });
            var values = dataArray.map(function (pair) {
                return pair[1];
            });


            // Create a new bar chart using Chart.js library
            if (bike_chart !== null) {
                  // If yes, destroy the existing chart
                 bike_chart.destroy();
            }
            var ctx = document.getElementById('barChart2').getContext('2d');
            bike_chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Bikes',
                        data: values,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)', // Change the bar color as needed
                        borderColor: 'rgba(75, 192, 192, 1)', // Change the bar border color as needed
                        borderWidth: 1 // Change the bar border width as needed
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25 // Set the maximum y-axis value to the highest value in the data plus 1
                        }
                    }
                }
            });
        }

        function initMap() {


            var dublin = {lat: 53.3498, lng: -6.2603};
            var map = new google.maps.Map(document.getElementById('map'), {zoom: 12, center: dublin});

            var locations = {{locations | tojson}};

            for (var i = 0; i < locations.length; i++) {
                var location = locations[i];

                var infoWindow = new google.maps.InfoWindow();
                var marker = new google.maps.Marker({
                    position: {lat: location[0], lng: location[1]},
                    map: map,
                });

                google.maps.event.addListener(marker, "click", (function (marker, location) {
                    return function () {
                        myFunction(location[5]);
                        standsFunction(location[5])
                        infoWindow.setContent(location[3] + "<br>Available bikes: " + location[2] + "<br>Available bike stands: " + location[4]);
                        infoWindow.open(map, marker);
                    }
                })(marker, location));
            }
        }

        function drawHeatmap() {
            var heatmapData = [];
            locations.forEach(function (location) {
                heatmapData.push({
                    location: new google.maps.LatLng(location['position_lat'], location['position_long']),
                    weight: location['address']
                });
            });
            heatmap = new google.maps.visualization.HeatmapLayer({
                data: heatmapData,
                map: map
            });
            heatmap.set('radius', 40);
        }

        // Call the drawHeatmap function
        drawHeatmap();
    </script>



    <style>
        /* Define container for map */
        .map-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
        }

        /* Define div for map */
        #map {
            flex: 1;
            height: 1000px;
        }

        /* Define div for box */
        #box {
            flex: 1;
            padding: 20px;
            background-color: lightgray;
            height: 100vh;
            width: 300px;}

    </style>
</head>
<header>

    <nav>

        <div class="topnav">
            <a href="/">Homepage</a>
            <a class="active" href="mapping.html">Map</a>
            <a href="how-to.html"> How To</a>
            <a href="news.html"> News</a>

        </div>


    </nav>

</header>
<body onload="initMap();">
<div class="map-container">
    <div id="map"></div> <!-- Map goes here -->

    <div id="box">     <div>
    <canvas id="barChart"></canvas>
    <canvas id="barChart2"></canvas>

</div>
    </div>
</div>



</body>
</html>





